<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KMD Piano Data Viewer</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3"></script>
    <style>
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

        :root {
            --bg-page: #f5f3ef;
            --bg-surface: #ffffff;
            --bg-surface-alt: #f9f7f4;
            --bg-black-key: #efece6;
            --text-primary: #1a1a2e;
            --text-secondary: #5a5a6e;
            --text-muted: #8a8a9a;
            --accent: #7a6548;
            --accent-hover: #5e4d36;
            --accent-light: rgba(122, 101, 72, 0.08);
            --border: #e5e2dc;
            --border-light: #eeebe6;
            --curve-down: #3b6fd4;
            --curve-up: #1a9e5c;
            --tw-line: #555;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.07), 0 1px 2px rgba(0,0,0,0.04);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.08), 0 2px 4px rgba(0,0,0,0.04);
            --shadow-lg: 0 8px 24px rgba(0,0,0,0.10), 0 4px 8px rgba(0,0,0,0.05);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --font: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            --color-down:     #5b9bd5;
            --color-balance:  #2ab3a3;
            --color-up:       #8b6db5;
            --color-friction: #e05c3a;
            --color-keydip:   #3a9c4a;
        }

        html { font-size: 15px; }
        body {
            font-family: var(--font);
            background: var(--bg-page);
            color: var(--text-primary);
            line-height: 1.5;
            min-height: 100vh;
        }

        /* ‚îÄ‚îÄ Landing Page ‚îÄ‚îÄ */
        #landing {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 24px;
            background: linear-gradient(160deg, #f5f3ef 0%, #ebe7df 100%);
        }
        #landing h1 {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 6px;
        }
        #landing .subtitle {
            font-size: 0.93rem;
            color: var(--text-secondary);
            margin-bottom: 36px;
            text-align: center;
            max-width: 420px;
            line-height: 1.6;
        }
        .drop-zone {
            width: 500px;
            max-width: 92vw;
            padding: 56px 40px;
            border: 2px dashed var(--border);
            border-radius: var(--radius-lg);
            text-align: center;
            cursor: pointer;
            transition: border-color 0.25s, background 0.25s;
            background: var(--bg-surface);
        }
        .drop-zone:hover, .drop-zone.dragover {
            border-color: var(--accent);
            background: var(--accent-light);
        }
        .drop-zone svg {
            margin-bottom: 16px;
            opacity: 0.55;
            transition: opacity 0.25s;
        }
        .drop-zone:hover svg, .drop-zone.dragover svg { opacity: 0.85; }
        .drop-zone p {
            color: var(--text-secondary);
            font-size: 0.95rem;
            margin-bottom: 4px;
        }
        .drop-zone .browse-label {
            color: var(--accent);
            font-weight: 600;
            text-decoration: underline;
            text-underline-offset: 2px;
        }
        #error-msg {
            margin-top: 20px;
            padding: 12px 20px;
            background: #fef2f2;
            color: #b91c1c;
            border-radius: var(--radius-sm);
            font-size: 0.88rem;
            max-width: 500px;
            display: none;
        }
        .version-history {
            margin-top: 36px;
            width: 500px;
            max-width: 92vw;
            text-align: left;
        }
        .version-history summary {
            font-size: 0.82rem;
            color: var(--text-muted);
            cursor: pointer;
            user-select: none;
            list-style: none;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .version-history summary::before {
            content: '‚ñ∂';
            font-size: 0.6rem;
            transition: transform 0.2s;
        }
        .version-history[open] summary::before { transform: rotate(90deg); }
        .version-history summary:hover { color: var(--text-secondary); }
        .version-history-entries {
            margin-top: 12px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .version-entry {
            display: flex;
            gap: 14px;
            font-size: 0.84rem;
        }
        .version-tag {
            font-weight: 700;
            color: var(--accent);
            white-space: nowrap;
            min-width: 28px;
        }
        .version-date {
            color: var(--text-muted);
            white-space: nowrap;
            font-size: 0.78rem;
            padding-top: 1px;
        }
        .version-notes {
            color: var(--text-secondary);
            line-height: 1.5;
        }

        /* ‚îÄ‚îÄ Easter Egg: Mini Game ‚îÄ‚îÄ */
        .game-trigger {
            position: fixed; bottom: 16px; right: 18px;
            font-size: 1.2rem; cursor: pointer; opacity: 0.15;
            transition: opacity 0.3s, transform 0.3s;
            user-select: none; z-index: 200; line-height: 1;
        }
        .game-trigger:hover { opacity: 1; transform: scale(1.35) rotate(-15deg); }
        #game-modal {
            position: fixed; inset: 0; background: rgba(8,8,20,0.85);
            z-index: 9999; display: none; align-items: center; justify-content: center;
            backdrop-filter: blur(6px);
        }
        #game-container {
            background: linear-gradient(160deg, #1e1b4b 0%, #12122a 100%);
            border-radius: 20px; padding: 26px 22px 20px;
            width: min(510px, 94vw); color: white; text-align: center;
            position: relative; box-shadow: 0 28px 90px rgba(0,0,0,0.75), 0 0 0 1px rgba(255,255,255,0.07);
        }
        .g-title {
            font-size: 1.45rem; font-weight: 800; margin-bottom: 4px;
            background: linear-gradient(135deg, #a29bfe, #fd79a8);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
        }
        .g-sub { font-size: 0.78rem; color: rgba(255,255,255,0.38); margin-bottom: 18px; letter-spacing: 0.5px; }
        .g-rules {
            background: rgba(255,255,255,0.06); border-radius: 10px;
            padding: 12px 14px; margin-bottom: 20px; text-align: left;
            font-size: 0.83rem; line-height: 2;
        }
        .g-rule-row { display: flex; align-items: center; gap: 10px; }
        .g-rule-dot { width: 11px; height: 11px; border-radius: 50%; flex-shrink: 0; }
        .g-btn {
            background: linear-gradient(135deg, #a29bfe, #fd79a8); color: white; border: none;
            padding: 10px 26px; border-radius: 10px; font-size: 0.93rem; font-weight: 700;
            cursor: pointer; font-family: var(--font);
            transition: transform 0.15s, box-shadow 0.15s;
            box-shadow: 0 4px 18px rgba(162,155,254,0.4);
        }
        .g-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 22px rgba(162,155,254,0.55); }
        .g-btn:active { transform: translateY(0); }
        .g-btn-sec {
            background: rgba(255,255,255,0.08); color: rgba(255,255,255,0.72);
            border: 1px solid rgba(255,255,255,0.14); padding: 10px 22px;
            border-radius: 10px; font-size: 0.93rem; cursor: pointer; font-family: var(--font);
            transition: background 0.2s;
        }
        .g-btn-sec:hover { background: rgba(255,255,255,0.14); }
        .g-close-btn {
            position: absolute; top: 12px; right: 12px;
            background: rgba(255,255,255,0.08); border: none; color: rgba(255,255,255,0.5);
            width: 28px; height: 28px; border-radius: 50%; cursor: pointer; font-size: 13px;
            display: flex; align-items: center; justify-content: center; transition: background 0.2s;
        }
        .g-close-btn:hover { background: rgba(255,255,255,0.16); }
        /* HUD */
        .g-hud { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .g-hud-item { display: flex; flex-direction: column; align-items: center; }
        .g-hud-label { font-size: 0.64rem; text-transform: uppercase; letter-spacing: 0.6px; color: rgba(255,255,255,0.32); margin-bottom: 2px; }
        .g-hud-val { font-size: 1.4rem; font-weight: 800; color: white; }
        #g-lives { font-size: 1rem; color: #fd79a8; letter-spacing: 4px; }
        /* Piano keyboard */
        #gkb { position: relative; height: 130px; margin: 0 0 10px; }
        .gk { position: absolute; top: 0; cursor: pointer; transition: filter 0.1s; overflow: visible; }
        .gk-w {
            height: 100%; background: #f0ece4;
            border-radius: 0 0 7px 7px; border: 1px solid #bbb; border-top: none;
            z-index: 1; display: flex; flex-direction: column;
            align-items: center; justify-content: flex-end; padding-bottom: 6px;
        }
        .gk-b {
            height: 63%; background: #16213e;
            border-radius: 0 0 5px 5px; border: 1px solid #0a0a1a; border-top: none;
            z-index: 2; box-shadow: 0 5px 10px rgba(0,0,0,0.55);
        }
        .gk-label { font-size: 0.58rem; color: #999; font-weight: 600; }
        .gk-w:hover { filter: brightness(0.94); }
        .gk-b:hover { filter: brightness(1.3); }
        .gk-w:active, .gk-b:active { transform: translateY(2px); }
        /* Active states */
        .gk-heavy { background: #ff7675 !important; box-shadow: 0 0 14px rgba(255,118,117,0.65) !important; }
        .gk-light  { background: #74b9ff !important; box-shadow: 0 0 14px rgba(116,185,255,0.65) !important; }
        .gk-good   { background: #55efc4 !important; box-shadow: 0 0 14px rgba(85,239,196,0.65) !important; }
        /* Badge */
        .gk-badge {
            position: absolute; top: -30px; left: 50%; transform: translateX(-50%);
            background: rgba(8,8,24,0.92); color: white; font-size: 0.68rem; font-weight: 700;
            padding: 3px 7px; border-radius: 6px; white-space: nowrap;
            z-index: 20; pointer-events: none; border: 1px solid rgba(255,255,255,0.12);
        }
        /* Progress bar */
        .gk-bar { position: absolute; bottom: 0; left: 0; height: 4px; width: 100%; border-radius: 2px; animation: gk-shrink linear forwards; }
        .gk-heavy .gk-bar { background: rgba(255,60,60,0.75); }
        .gk-light .gk-bar  { background: rgba(60,150,255,0.75); }
        .gk-good  .gk-bar  { background: rgba(40,200,140,0.75); }
        @keyframes gk-shrink { from { width: 100%; } to { width: 0; } }
        /* Feedback */
        #g-msg { height: 22px; font-size: 0.87rem; font-weight: 700; margin-bottom: 2px; }
        .g-pulse { animation: g-pulse-anim 0.28s ease; }
        @keyframes g-pulse-anim { 50% { transform: scale(1.45); color: #55efc4; } }
        .g-shake { animation: g-shake-anim 0.32s ease; }
        @keyframes g-shake-anim { 20%,60% { transform: translateX(-7px); } 40%,80% { transform: translateX(7px); } }
        /* End screen */
        .g-end-reason { font-size: 1.35rem; font-weight: 800; margin-bottom: 10px; background: linear-gradient(135deg, #a29bfe, #fd79a8); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .g-newbest { display: inline-block; background: linear-gradient(135deg, #ffd32a, #ff5e57); color: white; font-size: 0.76rem; font-weight: 800; padding: 3px 10px; border-radius: 20px; margin-bottom: 8px; letter-spacing: 0.3px; }
        .g-end-label { font-size: 0.68rem; text-transform: uppercase; letter-spacing: 0.6px; color: rgba(255,255,255,0.38); margin-bottom: 2px; }
        .g-end-score { font-size: 2.2rem; font-weight: 900; color: white; }
        .g-end-best { font-size: 0.86rem; color: rgba(255,255,255,0.4); margin: 5px 0 9px; }
        .g-end-grade { font-size: 1rem; color: #a29bfe; font-weight: 700; margin-bottom: 18px; }

        /* ‚îÄ‚îÄ App Shell ‚îÄ‚îÄ */
        #app { display: none; min-height: 100vh; flex-direction: column; }
        .app-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 24px;
            background: var(--bg-surface);
            border-bottom: 1px solid var(--border-light);
            box-shadow: var(--shadow-sm);
            position: sticky;
            top: 0;
            z-index: 100;
            gap: 16px;
            flex-wrap: wrap;
        }
        .piano-name {
            font-size: 1.15rem;
            font-weight: 700;
            color: var(--text-primary);
            white-space: nowrap;
        }
        .key-info {
            font-size: 0.95rem;
            color: var(--text-secondary);
            text-align: center;
            flex: 1;
            min-width: 0;
        }
        .key-info .key-label {
            font-weight: 600;
            color: var(--text-primary);
        }
        .key-info .note-label {
            color: var(--accent);
            font-weight: 700;
            margin-left: 6px;
        }
        .key-info .key-count {
            font-size: 0.82rem;
            color: var(--text-muted);
            margin-left: 8px;
        }
        .view-toggle {
            display: inline-flex;
            background: var(--bg-page);
            border-radius: var(--radius-sm);
            padding: 3px;
            gap: 2px;
            flex-shrink: 0;
        }
        .view-toggle button {
            padding: 7px 18px;
            border: none;
            background: transparent;
            border-radius: 6px;
            font-size: 0.85rem;
            font-family: var(--font);
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text-secondary);
            white-space: nowrap;
        }
        .view-toggle button.active {
            background: var(--bg-surface);
            box-shadow: var(--shadow-sm);
            color: var(--text-primary);
            font-weight: 600;
        }
        .view-toggle button:hover:not(.active) {
            color: var(--text-primary);
        }

        /* ‚îÄ‚îÄ Single Key View ‚îÄ‚îÄ */
        #single-view {
            display: flex;
            align-items: center;
            padding: 24px;
            gap: 20px;
            max-width: 1200px;
            margin: 0 auto;
            flex: 1;
            width: 100%;
        }
        .chart-area {
            flex: 1;
            min-width: 0;
            position: relative;
        }
        .chart-wrapper {
            background: var(--bg-surface);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-md);
            padding: 20px 20px 16px;
            position: relative;
        }
        .chart-container {
            position: relative;
            height: clamp(300px, 58vh, 600px);
        }
        .chart-container canvas { width: 100% !important; height: 100% !important; }

        .nav-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: var(--accent);
            color: #fff;
            border: none;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s, transform 0.15s, box-shadow 0.2s;
            z-index: 10;
            box-shadow: var(--shadow-md);
            line-height: 1;
        }
        .nav-btn:hover {
            background: var(--accent-hover);
            transform: translateY(-50%) scale(1.08);
            box-shadow: var(--shadow-lg);
        }
        .nav-btn:active { transform: translateY(-50%) scale(0.96); }
        #nav-prev { left: -22px; }
        #nav-next { right: -22px; }

        /* ‚îÄ‚îÄ Sidebar ‚îÄ‚îÄ */
        .sidebar {
            width: 150px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .metric {
            background: var(--bg-surface);
            border-radius: var(--radius-md);
            padding: 14px 12px;
            text-align: center;
            box-shadow: var(--shadow-sm);
            transition: box-shadow 0.2s;
        }
        .metric:hover { box-shadow: var(--shadow-md); }
        .metric-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.6px;
            color: var(--text-muted);
            margin-bottom: 4px;
            font-weight: 500;
        }
        .metric-value {
            font-size: 1.35rem;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1.2;
        }
        .metric-unit {
            font-size: 0.78rem;
            font-weight: 400;
            color: var(--text-muted);
        }

        /* ‚îÄ‚îÄ Overview View ‚îÄ‚îÄ */
        #overview-view {
            display: none;
            flex: 1;
            width: 100%;
            padding: 24px;
            box-sizing: border-box;
        }
        #overview-layout {
            display: flex;
            flex-direction: row;
            gap: 20px;
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
        }
        #overview-chart-area {
            flex: 1;
            min-width: 0;
            position: relative;
            height: clamp(300px, 65vh, 650px);
        }
        #overview-chart-area canvas { width: 100% !important; height: 100% !important; }
        #overview-sidebar {
            width: 160px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding-top: 4px;
        }
        .overview-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 10px;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            cursor: pointer;
            background: var(--bg-surface);
            font-family: var(--font);
            text-align: left;
            width: 100%;
            transition: opacity 0.2s, box-shadow 0.2s;
            box-shadow: var(--shadow-sm);
        }
        .overview-toggle:hover { box-shadow: var(--shadow-md); }
        .overview-toggle.hidden-metric { opacity: 0.35; }
        .overview-toggle-dot {
            width: 13px;
            height: 13px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        .overview-toggle-info { flex: 1; min-width: 0; }
        .overview-toggle-label {
            font-size: 0.68rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            font-weight: 500;
            margin-bottom: 2px;
        }
        .overview-toggle-value {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1.2;
        }

        /* ‚îÄ‚îÄ Grid View ‚îÄ‚îÄ */
        #grid-view { display: none; padding: 24px; max-width: 1400px; margin: 0 auto; width: 100%; }
        .keys-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(175px, 1fr));
            gap: 14px;
        }
        .key-card {
            background: var(--bg-surface);
            border-radius: var(--radius-md);
            padding: 12px;
            box-shadow: var(--shadow-sm);
            cursor: pointer;
            transition: transform 0.15s, box-shadow 0.2s;
            border: 2px solid transparent;
        }
        .key-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
            border-color: var(--accent);
        }
        .key-card.black-key { background: var(--bg-black-key); }
        .key-card-header {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 8px;
        }
        .key-card-num {
            font-size: 0.82rem;
            font-weight: 600;
            color: var(--text-secondary);
        }
        .key-card-note {
            font-size: 0.88rem;
            font-weight: 700;
            color: var(--accent);
        }
        .key-card-note .sharp-indicator {
            display: inline-block;
            width: 8px;
            height: 12px;
            background: #333;
            border-radius: 2px;
            vertical-align: middle;
            margin-right: 3px;
        }
        .mini-chart-container { height: 80px; margin-bottom: 8px; }
        .mini-chart-container canvas { width: 100% !important; height: 100% !important; }
        .key-card-stats {
            display: flex;
            justify-content: space-between;
            font-size: 0.72rem;
            color: var(--text-muted);
        }
        .key-card-stats span { white-space: nowrap; }
        .key-card-stats .stat-val { font-weight: 600; color: var(--text-secondary); }

        /* ‚îÄ‚îÄ Footer ‚îÄ‚îÄ */
        .app-footer {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 16px 24px;
            border-top: 1px solid var(--border-light);
            background: var(--bg-surface);
            flex-wrap: wrap;
        }
        .app-footer button {
            padding: 8px 18px;
            border: 1px solid var(--border);
            background: var(--bg-surface);
            border-radius: var(--radius-sm);
            font-size: 0.84rem;
            font-family: var(--font);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }
        .app-footer button:hover {
            border-color: var(--accent);
            color: var(--accent);
            background: var(--accent-light);
        }
        .app-footer button.primary {
            background: var(--accent);
            color: #fff;
            border-color: var(--accent);
        }
        .app-footer button.primary:hover {
            background: var(--accent-hover);
            border-color: var(--accent-hover);
        }
        .app-footer .separator {
            width: 1px;
            height: 24px;
            background: var(--border);
            margin: 0 6px;
        }

        /* ‚îÄ‚îÄ Legend ‚îÄ‚îÄ */
        .chart-legend {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 8px;
            font-size: 0.82rem;
            color: var(--text-secondary);
        }
        .chart-legend span {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .legend-swatch {
            width: 20px;
            height: 3px;
            border-radius: 2px;
        }

        /* ‚îÄ‚îÄ Responsive ‚îÄ‚îÄ */
        @media (max-width: 900px) {
            #single-view {
                flex-direction: column;
                padding: 16px;
            }
            .sidebar {
                width: 100%;
                flex-direction: row;
                flex-wrap: wrap;
                justify-content: center;
            }
            .metric { min-width: 100px; max-width: 150px; }
            .chart-container { height: 320px; }
            #nav-prev { left: 4px; }
            #nav-next { right: 4px; }
            .nav-btn {
                width: 36px;
                height: 36px;
                font-size: 15px;
            }
        }
        @media (max-width: 600px) {
            .app-header { padding: 10px 16px; }
            .piano-name { font-size: 1rem; }
            .keys-grid { grid-template-columns: repeat(auto-fill, minmax(145px, 1fr)); gap: 10px; }
            .chart-container { height: 260px; }
        }
    </style>
</head>
<body>

<script id="embedded-data" type="application/json">null</script>

<!-- ‚ïê‚ïê‚ïê Easter Egg: Mini Game ‚ïê‚ïê‚ïê -->
<div class="game-trigger" onclick="openEasterEgg()" title="pssst...">üéπ</div>

<div id="game-modal" onclick="if(event.target===this)closeEasterEgg()">
    <div id="game-container">
        <!-- Start screen -->
        <div id="game-start">
            <div class="g-title">üéπ Regulate That Key!</div>
            <div class="g-sub">Piano Technician Simulator</div>
            <div class="g-rules">
                <div class="g-rule-row"><span class="g-rule-dot" style="background:#ff7675"></span><span><strong>Red</strong> ‚Äî too heavy (&gt;58g). Click to fix!</span></div>
                <div class="g-rule-row"><span class="g-rule-dot" style="background:#74b9ff"></span><span><strong>Blue</strong> ‚Äî too light (&lt;42g). Click to fix!</span></div>
                <div class="g-rule-row"><span class="g-rule-dot" style="background:#55efc4"></span><span><strong>Green</strong> ‚Äî in spec (42‚Äì58g). Don't touch!</span></div>
            </div>
            <button class="g-btn" onclick="startGame()">Start Tuning!</button>
        </div>
        <!-- Play screen -->
        <div id="game-play" style="display:none">
            <div class="g-hud">
                <div class="g-hud-item">
                    <span class="g-hud-label">Score</span>
                    <span class="g-hud-val" id="g-score">0</span>
                </div>
                <div class="g-hud-item">
                    <span id="g-lives">‚ô•‚ô•‚ô•</span>
                </div>
                <div class="g-hud-item">
                    <span class="g-hud-label">Time</span>
                    <span class="g-hud-val" id="g-time">60</span>
                </div>
            </div>
            <div id="gkb"></div>
            <div id="g-msg"></div>
        </div>
        <!-- Game over screen -->
        <div id="game-over" style="display:none">
            <div class="g-end-reason" id="g-reason">Time's up!</div>
            <div class="g-newbest" id="g-newbest">üåü New Best!</div>
            <div class="g-end-label">Score</div>
            <div class="g-end-score" id="g-final">0</div>
            <div class="g-end-best">Best: <span id="g-best">0</span></div>
            <div class="g-end-grade" id="g-grade"></div>
            <div style="display:flex;gap:12px;justify-content:center">
                <button class="g-btn" onclick="startGame()">Play Again</button>
                <button class="g-btn-sec" onclick="closeEasterEgg()">Close</button>
            </div>
        </div>
        <button class="g-close-btn" onclick="closeEasterEgg()">‚úï</button>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê Landing Page ‚ïê‚ïê‚ïê -->
<div id="landing">
    <h1>KMD Piano Data Viewer</h1>
    <p class="subtitle">
        Open and view KMD measurement files without the device connected.
        View touchweight curves, key-dip, friction, and more for every key.
    </p>
    <div class="drop-zone" id="drop-zone">
        <svg viewBox="0 0 48 48" width="48" height="48" fill="none" stroke="#7a6548" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M24 30V8"/>
            <path d="M16 16l8-8 8 8"/>
            <path d="M8 28v10a4 4 0 004 4h24a4 4 0 004-4V28"/>
        </svg>
        <p>Drag &amp; drop a KMD <strong>.json</strong> file here</p>
        <p>or <span class="browse-label">click to browse</span></p>
    </div>
    <input type="file" id="file-input" accept=".json" hidden>
    <div id="error-msg"></div>
    <details class="version-history">
        <summary>Version history</summary>
        <div class="version-history-entries">
            <div class="version-entry">
                <span class="version-tag">v3</span>
                <span class="version-date">2026-02-18</span>
                <span class="version-notes">Added version history. Added a secret easter egg ‚Äî find the üéπ and play <strong>Regulate That Key!</strong>, a piano technician mini game.</span>
            </div>
            <div class="version-entry">
                <span class="version-tag">v2</span>
                <span class="version-date">2026-02-18</span>
                <span class="version-notes">Added <strong>All Keys</strong> overview chart ‚Äî scatter plot of all 5 weight metrics (down, balance, up, friction, keydip) across all keys with per-metric toggle buttons. Renamed mini-chart grid to <strong>All Curves</strong>.</span>
            </div>
            <div class="version-entry">
                <span class="version-tag">v1</span>
                <span class="version-date">2026-02-15</span>
                <span class="version-notes">Initial release ‚Äî single key touchweight curves with analysis range, key-by-key navigation, mini-chart grid, shareable HTML export, PNG and CSV export.</span>
            </div>
        </div>
    </details>
</div>

<!-- ‚ïê‚ïê‚ïê Main Application ‚ïê‚ïê‚ïê -->
<div id="app">
    <header class="app-header">
        <div class="piano-name" id="piano-name"></div>
        <div class="key-info" id="key-info"></div>
        <div class="view-toggle">
            <button id="btn-single" class="active" onclick="switchView('single')">Single Key</button>
            <button id="btn-overview" onclick="switchView('overview')">All Keys</button>
            <button id="btn-all" onclick="switchView('grid')">All Curves</button>
        </div>
    </header>

    <!-- Single Key Detail -->
    <div id="single-view">
        <div class="chart-area">
            <div class="chart-wrapper">
                <button class="nav-btn" id="nav-prev" onclick="navigateKey(-1)" title="Previous key (Left arrow)">&#9664;</button>
                <div class="chart-container">
                    <canvas id="main-chart"></canvas>
                </div>
                <button class="nav-btn" id="nav-next" onclick="navigateKey(1)" title="Next key (Right arrow)">&#9654;</button>
            </div>
            <div class="chart-legend">
                <span><span class="legend-swatch" style="background:var(--curve-down)"></span>Downstroke</span>
                <span><span class="legend-swatch" style="background:var(--curve-up)"></span>Upstroke</span>
                <span><span class="legend-swatch" style="background:var(--tw-line); height:12px; width:2px; border-left:2px dashed var(--tw-line); background:none;"></span>Analysis Range</span>
            </div>
        </div>
        <div class="sidebar" id="sidebar">
            <div class="metric"><div class="metric-label">Down Weight</div><div class="metric-value" id="val-dw">--</div></div>
            <div class="metric"><div class="metric-label">Balance</div><div class="metric-value" id="val-bal">--</div></div>
            <div class="metric"><div class="metric-label">Up Weight</div><div class="metric-value" id="val-uw">--</div></div>
            <div class="metric"><div class="metric-label">Friction</div><div class="metric-value" id="val-fri">--</div></div>
            <div class="metric"><div class="metric-label">Key-dip</div><div class="metric-value" id="val-dip">--</div></div>
        </div>
    </div>

    <!-- All Keys Overview -->
    <div id="overview-view">
        <div id="overview-layout">
            <div id="overview-chart-area">
                <canvas id="overview-canvas"></canvas>
            </div>
            <div id="overview-sidebar"></div>
        </div>
    </div>

    <!-- All Curves Grid -->
    <div id="grid-view">
        <div class="keys-grid" id="keys-grid"></div>
    </div>

    <footer class="app-footer">
        <button class="primary" onclick="exportShareableHTML()">Save Shareable HTML</button>
        <button onclick="exportPNG()">Export Chart as PNG</button>
        <button onclick="exportCSV()">Export Summary CSV</button>
        <div class="separator"></div>
        <button onclick="loadNewFile()">Load Different File</button>
    </footer>
</div>

<script>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   KMD Piano Data Viewer ‚Äî All-in-one JavaScript
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

// Capture original HTML before DOM changes (for shareable export)
const ORIGINAL_HTML = '<!DOCTYPE html>\n' + document.documentElement.outerHTML;

// ‚îÄ‚îÄ Constants ‚îÄ‚îÄ
const NOTE_NAMES = ['A', 'A#', 'B', 'C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#'];
const BLACK_KEY_OFFSETS = new Set([1, 4, 6, 9, 11]); // A#, C#, D#, F#, G#

// ‚îÄ‚îÄ State ‚îÄ‚îÄ
let kmdData = null;
let validIndices = [];
let currentKeyIndex = 0;
let currentView = 'single';
let singleChart = null;
let overviewChart = null;
let miniCharts = {};
let gridObserver = null;

const METRIC_CONFIG = [
    { label: 'Down weight',    field: 'downweight_data',    color: '#5b9bd5', unit: 'g' },
    { label: 'Balance weight', field: 'balanceweight_data', color: '#2ab3a3', unit: 'g' },
    { label: 'Up weight',      field: 'upweight_data',      color: '#8b6db5', unit: 'g' },
    { label: 'Friction',       field: 'friction_data',      color: '#e05c3a', unit: 'g' },
    { label: 'Keydip',         field: 'keydip_data',        color: '#3a9c4a', unit: 'mm' },
];

// ‚îÄ‚îÄ Utilities ‚îÄ‚îÄ
function getNoteName(keyNumber) {
    const noteIndex = (keyNumber - 1) % 12;
    const octave = Math.floor((keyNumber - 1 + 9) / 12);
    return NOTE_NAMES[noteIndex] + octave;
}

function isBlackKey(keyNumber) {
    return BLACK_KEY_OFFSETS.has((keyNumber - 1) % 12);
}

function fmt(val, decimals) {
    if (val == null || isNaN(val)) return '--';
    return val.toFixed(decimals !== undefined ? decimals : 1);
}

// ‚îÄ‚îÄ Data Loading ‚îÄ‚îÄ
function showError(msg) {
    const el = document.getElementById('error-msg');
    el.textContent = msg;
    el.style.display = 'block';
}

function hideError() {
    document.getElementById('error-msg').style.display = 'none';
}

function validateData(data) {
    const required = ['pianoname', 'keynumber_data', 'xyvalues_data',
        'downweight_data', 'upweight_data', 'balanceweight_data',
        'friction_data', 'keydip_data'];
    for (const key of required) {
        if (!(key in data)) throw new Error('Missing required field: ' + key);
    }
    if (!Array.isArray(data.keynumber_data) || data.keynumber_data.length < 2) {
        throw new Error('keynumber_data must be an array with at least one key');
    }
}

function loadData(data) {
    validateData(data);
    kmdData = data;

    // Build list of valid key indices
    validIndices = [];
    for (let i = 0; i < data.keynumber_data.length; i++) {
        if (data.keynumber_data[i] != null && data.xyvalues_data[i] != null) {
            validIndices.push(i);
        }
    }
    if (validIndices.length === 0) throw new Error('No valid key data found in file');

    currentKeyIndex = validIndices[0];
    document.getElementById('landing').style.display = 'none';
    document.getElementById('app').style.display = 'flex';
    document.getElementById('piano-name').textContent = data.pianoname || 'Untitled Piano';

    switchView('single');
}

function readJSONFile(file) {
    hideError();
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = JSON.parse(e.target.result);
            loadData(data);
        } catch (err) {
            showError('Could not read file: ' + err.message);
        }
    };
    reader.onerror = function() { showError('Error reading file.'); };
    reader.readAsText(file);
}

// ‚îÄ‚îÄ Chart Creation ‚îÄ‚îÄ
function splitCurves(xyData) {
    if (!xyData || xyData.length === 0) return { down: [], up: [] };
    // Find the index with max x (the turnaround point)
    let maxXIdx = 0;
    let maxX = -Infinity;
    for (let i = 0; i < xyData.length; i++) {
        if (xyData[i].x > maxX) { maxX = xyData[i].x; maxXIdx = i; }
    }
    const down = xyData.slice(0, maxXIdx + 1).map(p => ({ x: p.x, y: p.y }));
    const up = xyData.slice(maxXIdx).map(p => ({ x: p.x, y: p.y }));
    return { down, up };
}

function getChartConfig(keyIndex, mini) {
    const xyData = kmdData.xyvalues_data[keyIndex];
    const { down, up } = splitCurves(xyData);
    const twWindow = kmdData.twwindow_data ? kmdData.twwindow_data[keyIndex] : null;

    const annotations = {};
    if (!mini && twWindow && twWindow.length >= 2) {
        annotations.twLeft = {
            type: 'line',
            xMin: twWindow[0].x,
            xMax: twWindow[0].x,
            borderColor: 'rgba(80,80,80,0.6)',
            borderWidth: 2,
            borderDash: [6, 4],
        };
        annotations.twRight = {
            type: 'line',
            xMin: twWindow[1].x,
            xMax: twWindow[1].x,
            borderColor: 'rgba(80,80,80,0.6)',
            borderWidth: 2,
            borderDash: [6, 4],
        };
    }

    return {
        type: 'scatter',
        data: {
            datasets: [
                {
                    label: 'Downstroke',
                    data: down,
                    showLine: true,
                    borderColor: getComputedStyle(document.documentElement).getPropertyValue('--curve-down').trim(),
                    backgroundColor: 'transparent',
                    borderWidth: mini ? 1.5 : 2.5,
                    pointRadius: 0,
                    tension: 0.3,
                    order: 1,
                },
                {
                    label: 'Upstroke',
                    data: up,
                    showLine: true,
                    borderColor: getComputedStyle(document.documentElement).getPropertyValue('--curve-up').trim(),
                    backgroundColor: 'transparent',
                    borderWidth: mini ? 1.5 : 2.5,
                    pointRadius: 0,
                    tension: 0.3,
                    order: 2,
                },
            ],
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: mini ? false : { duration: 300 },
            interaction: mini ? { mode: null } : { mode: 'nearest', intersect: false },
            plugins: {
                legend: { display: false },
                tooltip: mini ? { enabled: false } : {
                    backgroundColor: 'rgba(30,30,50,0.88)',
                    titleFont: { size: 12 },
                    bodyFont: { size: 12 },
                    padding: 10,
                    cornerRadius: 8,
                    callbacks: {
                        label: function(ctx) {
                            return ctx.dataset.label + ': ' + fmt(ctx.parsed.y) + 'g at ' + fmt(ctx.parsed.x) + 'mm';
                        }
                    }
                },
                annotation: Object.keys(annotations).length > 0 ? { annotations } : undefined,
            },
            scales: {
                x: mini ? { display: false, min: 0 } : {
                    title: { display: true, text: 'Keystroke Position (mm)', font: { size: 13 }, color: '#666' },
                    min: 0,
                    grid: { color: '#eee' },
                    ticks: { color: '#888', font: { size: 11 } },
                },
                y: mini ? { display: false, min: 0 } : {
                    title: { display: true, text: 'Touchweight (grams)', font: { size: 13 }, color: '#666' },
                    min: 0,
                    grid: { color: '#eee' },
                    ticks: { color: '#888', font: { size: 11 } },
                },
            },
        },
    };
}

function createSingleChart() {
    const canvas = document.getElementById('main-chart');
    if (singleChart) { singleChart.destroy(); singleChart = null; }
    singleChart = new Chart(canvas, getChartConfig(currentKeyIndex, false));
}

function updateSingleChart() {
    if (!singleChart) { createSingleChart(); return; }
    const xyData = kmdData.xyvalues_data[currentKeyIndex];
    const { down, up } = splitCurves(xyData);
    const twWindow = kmdData.twwindow_data ? kmdData.twwindow_data[currentKeyIndex] : null;

    singleChart.data.datasets[0].data = down;
    singleChart.data.datasets[1].data = up;

    // Update annotation lines
    if (singleChart.options.plugins.annotation && twWindow && twWindow.length >= 2) {
        const ann = singleChart.options.plugins.annotation.annotations;
        if (ann.twLeft) { ann.twLeft.xMin = twWindow[0].x; ann.twLeft.xMax = twWindow[0].x; }
        if (ann.twRight) { ann.twRight.xMin = twWindow[1].x; ann.twRight.xMax = twWindow[1].x; }
    } else if (twWindow && twWindow.length >= 2) {
        singleChart.options.plugins.annotation = {
            annotations: {
                twLeft: { type: 'line', xMin: twWindow[0].x, xMax: twWindow[0].x, borderColor: 'rgba(80,80,80,0.6)', borderWidth: 2, borderDash: [6, 4] },
                twRight: { type: 'line', xMin: twWindow[1].x, xMax: twWindow[1].x, borderColor: 'rgba(80,80,80,0.6)', borderWidth: 2, borderDash: [6, 4] },
            }
        };
    }

    singleChart.update('none');
}

// ‚îÄ‚îÄ UI Updates ‚îÄ‚îÄ
function updateSidebar() {
    const idx = currentKeyIndex;
    document.getElementById('val-dw').innerHTML = fmt(kmdData.downweight_data[idx]) + '<span class="metric-unit">g</span>';
    document.getElementById('val-bal').innerHTML = fmt(kmdData.balanceweight_data[idx]) + '<span class="metric-unit">g</span>';
    document.getElementById('val-uw').innerHTML = fmt(kmdData.upweight_data[idx]) + '<span class="metric-unit">g</span>';
    document.getElementById('val-fri').innerHTML = fmt(kmdData.friction_data[idx]) + '<span class="metric-unit">g</span>';
    document.getElementById('val-dip').innerHTML = fmt(kmdData.keydip_data[idx]) + '<span class="metric-unit">mm</span>';
}

function updateHeader() {
    const keyNum = kmdData.keynumber_data[currentKeyIndex];
    const noteName = getNoteName(keyNum);
    const pos = validIndices.indexOf(currentKeyIndex);
    const total = validIndices.length;
    document.getElementById('key-info').innerHTML =
        '<span class="key-label">Key ' + keyNum + '</span>' +
        '<span class="note-label">' + noteName + '</span>' +
        '<span class="key-count">(' + (pos + 1) + ' of ' + total + ')</span>';
}

function renderSingleView() {
    updateSingleChart();
    updateSidebar();
    updateHeader();
}

function navigateKey(delta) {
    const pos = validIndices.indexOf(currentKeyIndex);
    let newPos = pos + delta;
    if (newPos < 0) newPos = validIndices.length - 1;
    if (newPos >= validIndices.length) newPos = 0;
    currentKeyIndex = validIndices[newPos];
    renderSingleView();
}

// ‚îÄ‚îÄ Grid View ‚îÄ‚îÄ
function destroyMiniCharts() {
    for (const key in miniCharts) {
        if (miniCharts[key]) miniCharts[key].destroy();
    }
    miniCharts = {};
    if (gridObserver) { gridObserver.disconnect(); gridObserver = null; }
}

function buildGrid() {
    const grid = document.getElementById('keys-grid');
    grid.innerHTML = '';
    destroyMiniCharts();

    validIndices.forEach(function(idx) {
        const keyNum = kmdData.keynumber_data[idx];
        const note = getNoteName(keyNum);
        const black = isBlackKey(keyNum);

        const card = document.createElement('div');
        card.className = 'key-card' + (black ? ' black-key' : '');
        card.dataset.keyIndex = idx;

        const dw = kmdData.downweight_data[idx];
        const uw = kmdData.upweight_data[idx];
        const dip = kmdData.keydip_data[idx];

        card.innerHTML =
            '<div class="key-card-header">' +
                '<span class="key-card-num">Key ' + keyNum + '</span>' +
                '<span class="key-card-note">' + (black ? '<span class="sharp-indicator"></span>' : '') + note + '</span>' +
            '</div>' +
            '<div class="mini-chart-container"><canvas></canvas></div>' +
            '<div class="key-card-stats">' +
                '<span>DW <span class="stat-val">' + fmt(dw) + 'g</span></span>' +
                '<span>UW <span class="stat-val">' + fmt(uw) + 'g</span></span>' +
                '<span>Dip <span class="stat-val">' + fmt(dip) + 'mm</span></span>' +
            '</div>';

        card.addEventListener('click', function() {
            currentKeyIndex = idx;
            switchView('single');
        });

        grid.appendChild(card);
    });

    // Lazy-render mini charts
    gridObserver = new IntersectionObserver(function(entries) {
        entries.forEach(function(entry) {
            if (entry.isIntersecting) {
                const card = entry.target;
                const idx = parseInt(card.dataset.keyIndex);
                const canvas = card.querySelector('canvas');
                if (!miniCharts[idx]) {
                    miniCharts[idx] = new Chart(canvas, getChartConfig(idx, true));
                }
                gridObserver.unobserve(card);
            }
        });
    }, { rootMargin: '200px' });

    grid.querySelectorAll('.key-card').forEach(function(card) {
        gridObserver.observe(card);
    });
}

// ‚îÄ‚îÄ Overview View ‚îÄ‚îÄ
function buildOverview() {
    if (overviewChart) { overviewChart.destroy(); overviewChart = null; }
    const canvas = document.getElementById('overview-canvas');
    const datasets = METRIC_CONFIG.map(function(m) {
        return {
            label: m.label,
            data: validIndices.map(function(i) { return { x: i, y: kmdData[m.field][i] }; }),
            backgroundColor: m.color,
            pointRadius: 4,
            pointHoverRadius: 6,
            showLine: false,
        };
    });
    overviewChart = new Chart(canvas, {
        type: 'scatter',
        data: { datasets: datasets },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: { duration: 200 },
            scales: {
                x: {
                    title: { display: true, text: 'Key Number', font: { size: 13 }, color: '#666' },
                    min: 0,
                    max: 88,
                    grid: { color: '#eee' },
                    ticks: { color: '#888', font: { size: 11 } },
                },
                y: {
                    title: { display: true, text: '(g) or (mm)', font: { size: 13 }, color: '#666' },
                    min: 0,
                    grid: { color: '#eee' },
                    ticks: { color: '#888', font: { size: 11 } },
                },
            },
            plugins: {
                legend: { display: false },
                tooltip: {
                    backgroundColor: 'rgba(30,30,50,0.88)',
                    titleFont: { size: 12 },
                    bodyFont: { size: 12 },
                    padding: 10,
                    cornerRadius: 8,
                    callbacks: {
                        label: function(ctx) {
                            const m = METRIC_CONFIG[ctx.datasetIndex];
                            return ctx.dataset.label + ': ' + ctx.parsed.y.toFixed(1) + m.unit;
                        }
                    }
                },
                annotation: {
                    annotations: {
                        selectedKey: {
                            type: 'line',
                            xMin: currentKeyIndex,
                            xMax: currentKeyIndex,
                            borderColor: 'rgba(0,0,0,0.35)',
                            borderWidth: 1.5,
                            borderDash: [4, 4],
                        }
                    }
                },
            },
            onClick: function(event) {
                const xVal = overviewChart.scales.x.getValueForPixel(event.x);
                if (xVal == null || validIndices.length === 0) return;
                const nearest = validIndices.reduce(function(prev, curr) {
                    return Math.abs(curr - xVal) < Math.abs(prev - xVal) ? curr : prev;
                });
                currentKeyIndex = nearest;
                updateHeader();
                updateOverviewSidebar();
                const ann = overviewChart.options.plugins.annotation.annotations.selectedKey;
                ann.xMin = nearest;
                ann.xMax = nearest;
                overviewChart.update('none');
            },
        },
    });
    buildOverviewSidebar();
}

function buildOverviewSidebar() {
    const sidebar = document.getElementById('overview-sidebar');
    sidebar.innerHTML = '';
    METRIC_CONFIG.forEach(function(m, i) {
        const btn = document.createElement('button');
        btn.className = 'overview-toggle';
        btn.dataset.index = i;
        btn.innerHTML =
            '<span class="overview-toggle-dot" style="background:' + m.color + '"></span>' +
            '<span class="overview-toggle-info">' +
                '<div class="overview-toggle-label">' + m.label + '</div>' +
                '<div class="overview-toggle-value" id="ov-val-' + i + '">‚Äî</div>' +
            '</span>';
        btn.addEventListener('click', function() { toggleOverviewDataset(i); });
        sidebar.appendChild(btn);
    });
    updateOverviewSidebar();
}

function updateOverviewSidebar() {
    METRIC_CONFIG.forEach(function(m, i) {
        const el = document.getElementById('ov-val-' + i);
        if (!el) return;
        const val = kmdData[m.field][currentKeyIndex];
        el.textContent = val != null ? val.toFixed(1) + m.unit : '‚Äî';
    });
}

function toggleOverviewDataset(index) {
    const dataset = overviewChart.data.datasets[index];
    dataset.hidden = !dataset.hidden;
    const btn = document.querySelector('.overview-toggle[data-index="' + index + '"]');
    btn.classList.toggle('hidden-metric', dataset.hidden);
    overviewChart.update('none');
}

// ‚îÄ‚îÄ View Switching ‚îÄ‚îÄ
function switchView(view) {
    currentView = view;
    const singleView = document.getElementById('single-view');
    const overviewView = document.getElementById('overview-view');
    const gridView = document.getElementById('grid-view');
    const btnSingle = document.getElementById('btn-single');
    const btnOverview = document.getElementById('btn-overview');
    const btnAll = document.getElementById('btn-all');

    btnSingle.classList.remove('active');
    btnOverview.classList.remove('active');
    btnAll.classList.remove('active');

    if (view === 'single') {
        if (overviewChart) { overviewChart.destroy(); overviewChart = null; }
        destroyMiniCharts();
        overviewView.style.display = 'none';
        gridView.style.display = 'none';
        singleView.style.display = '';
        btnSingle.classList.add('active');
        renderSingleView();
    } else if (view === 'overview') {
        if (singleChart) { singleChart.destroy(); singleChart = null; }
        destroyMiniCharts();
        singleView.style.display = 'none';
        gridView.style.display = 'none';
        overviewView.style.display = 'block';
        btnOverview.classList.add('active');
        buildOverview();
    } else {
        if (singleChart) { singleChart.destroy(); singleChart = null; }
        if (overviewChart) { overviewChart.destroy(); overviewChart = null; }
        singleView.style.display = 'none';
        overviewView.style.display = 'none';
        gridView.style.display = 'block';
        btnAll.classList.add('active');
        buildGrid();
    }
}

// ‚îÄ‚îÄ Export Functions ‚îÄ‚îÄ
function exportShareableHTML() {
    if (!kmdData) return;
    const dataStr = btoa(unescape(encodeURIComponent(JSON.stringify(kmdData))));
    const exportHTML = ORIGINAL_HTML.replace(
        '<script id="embedded-data" type="application/json">null<\/script>',
        '<script id="embedded-data" type="application/json">' + dataStr + '<\/script>'
    );
    downloadBlob(exportHTML, 'KMD-' + (kmdData.pianoname || 'piano') + '.html', 'text/html');
}

function exportPNG() {
    if (!singleChart) return;
    const link = document.createElement('a');
    link.download = 'KMD-Key' + kmdData.keynumber_data[currentKeyIndex] + '-' + getNoteName(kmdData.keynumber_data[currentKeyIndex]) + '.png';
    link.href = singleChart.toBase64Image();
    link.click();
}

function exportCSV() {
    if (!kmdData) return;
    let csv = 'Key,Note,Down Weight (g),Up Weight (g),Balance (g),Friction (g),Key Dip (mm)\n';
    validIndices.forEach(function(idx) {
        const kn = kmdData.keynumber_data[idx];
        csv += kn + ',' + getNoteName(kn) + ',' +
            fmt(kmdData.downweight_data[idx]) + ',' +
            fmt(kmdData.upweight_data[idx]) + ',' +
            fmt(kmdData.balanceweight_data[idx]) + ',' +
            fmt(kmdData.friction_data[idx]) + ',' +
            fmt(kmdData.keydip_data[idx]) + '\n';
    });
    downloadBlob(csv, 'KMD-' + (kmdData.pianoname || 'piano') + '-summary.csv', 'text/csv');
}

function downloadBlob(content, filename, mimeType) {
    const blob = new Blob([content], { type: mimeType });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function loadNewFile() {
    if (singleChart) { singleChart.destroy(); singleChart = null; }
    if (overviewChart) { overviewChart.destroy(); overviewChart = null; }
    destroyMiniCharts();
    kmdData = null;
    validIndices = [];
    document.getElementById('app').style.display = 'none';
    document.getElementById('landing').style.display = '';
}

// ‚îÄ‚îÄ Easter Egg: Mini Game ‚îÄ‚îÄ
let gameActive = false;
let gameScore = 0;
let gameLives = 3;
let gameTimeLeft = 60;
let gameTimerInt = null;
let gameSpawnInt = null;
let gameAudio = null;
let gameHighScore = 0;
let gameCombo = 0;
const keyTimers = new Map();

const GAME_NOTES = [
    { name: 'C',  black: false, whiteIdx: 0 },
    { name: 'C#', black: true,  whiteLeft: 0 },
    { name: 'D',  black: false, whiteIdx: 1 },
    { name: 'D#', black: true,  whiteLeft: 1 },
    { name: 'E',  black: false, whiteIdx: 2 },
    { name: 'F',  black: false, whiteIdx: 3 },
    { name: 'F#', black: true,  whiteLeft: 3 },
    { name: 'G',  black: false, whiteIdx: 4 },
    { name: 'G#', black: true,  whiteLeft: 4 },
    { name: 'A',  black: false, whiteIdx: 5 },
    { name: 'A#', black: true,  whiteLeft: 5 },
    { name: 'B',  black: false, whiteIdx: 6 },
];
const GAME_FREQS = [261.63, 277.18, 293.66, 311.13, 329.63, 349.23, 369.99, 392.00, 415.30, 440.00, 466.16, 493.88];
const G_HEAVY = 58, G_LIGHT = 42;

function openEasterEgg() {
    buildGameKeyboard();
    showGamePanel('game-start');
    document.getElementById('game-modal').style.display = 'flex';
}

function closeEasterEgg() {
    stopGame();
    document.getElementById('game-modal').style.display = 'none';
}

function showGamePanel(id) {
    ['game-start', 'game-play', 'game-over'].forEach(function(s) {
        document.getElementById(s).style.display = s === id ? '' : 'none';
    });
}

function buildGameKeyboard() {
    const kb = document.getElementById('gkb');
    kb.innerHTML = '';
    const W = 100 / 7;
    const BW = W * 0.58;
    GAME_NOTES.forEach(function(note, i) {
        const key = document.createElement('div');
        key.className = 'gk ' + (note.black ? 'gk-b' : 'gk-w');
        key.id = 'gk-' + i;
        if (note.black) {
            const center = (note.whiteLeft + 0.65) * W;
            key.style.left = (center - BW / 2) + '%';
            key.style.width = BW + '%';
        } else {
            key.style.left = (note.whiteIdx * W) + '%';
            key.style.width = W + '%';
            key.innerHTML = '<span class="gk-label">' + note.name + '</span>';
        }
        key.addEventListener('click', (function(idx, isBlack) {
            return function(e) { if (isBlack) e.stopPropagation(); onKeyClick(idx); };
        })(i, note.black));
        kb.appendChild(key);
    });
}

function startGame() {
    gameActive = true;
    gameScore = 0; gameLives = 3; gameTimeLeft = 60; gameCombo = 0;
    document.getElementById('g-score').textContent = '0';
    document.getElementById('g-time').textContent = '60';
    updateLives();
    document.getElementById('g-msg').textContent = '';
    document.querySelectorAll('.gk').forEach(clearKey);
    showGamePanel('game-play');

    gameTimerInt = setInterval(function() {
        gameTimeLeft--;
        document.getElementById('g-time').textContent = gameTimeLeft;
        if (gameTimeLeft === 40 || gameTimeLeft === 20) {
            clearInterval(gameSpawnInt);
            gameSpawnInt = setInterval(trySpawn, gameTimeLeft === 40 ? 1400 : 1000);
        }
        if (gameTimeLeft <= 0) gameOver('time');
    }, 1000);

    trySpawn();
    gameSpawnInt = setInterval(trySpawn, 1800);
}

function trySpawn() {
    if (!gameActive) return;
    const idle = Array.from(document.querySelectorAll('.gk')).filter(function(k) { return !k.dataset.active; });
    if (idle.length === 0) return;
    const key = idle[Math.floor(Math.random() * idle.length)];
    const noteIdx = parseInt(key.id.replace('gk-', ''));

    // Weight distribution: 35% light, 35% heavy, 30% in-spec
    const r = Math.random();
    let weight;
    if (r < 0.35) weight = 30 + Math.random() * 11;       // light: 30‚Äì41
    else if (r < 0.70) weight = 59 + Math.random() * 13;  // heavy: 59‚Äì72
    else weight = G_LIGHT + Math.random() * (G_HEAVY - G_LIGHT); // good
    weight = Math.round(weight * 10) / 10;

    const type = weight > G_HEAVY ? 'heavy' : weight < G_LIGHT ? 'light' : 'good';
    key.dataset.active = '1';
    key.dataset.type = type;
    key.classList.add('gk-' + type);

    const badge = document.createElement('div');
    badge.className = 'gk-badge';
    badge.textContent = weight.toFixed(1) + 'g';
    key.appendChild(badge);

    const bar = document.createElement('div');
    bar.className = 'gk-bar';
    const dur = type === 'good' ? 1600 : 2400;
    bar.style.animationDuration = dur + 'ms';
    key.appendChild(bar);

    const tid = setTimeout(function() {
        if (!key.dataset.active) return;
        if (type !== 'good') {
            gameLives--;
            updateLives();
            flashMsg('Missed! ‚ô©', '#ff7675');
            gameCombo = 0;
            if (gameLives <= 0) { gameOver('lives'); return; }
        }
        clearKey(key);
    }, dur);
    keyTimers.set(key, tid);
}

function onKeyClick(noteIdx) {
    if (!gameActive) return;
    const key = document.getElementById('gk-' + noteIdx);
    if (!key || !key.dataset.active) return;
    clearTimeout(keyTimers.get(key));
    keyTimers.delete(key);
    const type = key.dataset.type;
    if (type === 'heavy' || type === 'light') {
        gameCombo++;
        const mult = gameCombo >= 5 ? 3 : gameCombo >= 3 ? 2 : 1;
        const pts = 10 * mult;
        gameScore += pts;
        document.getElementById('g-score').textContent = gameScore;
        playGameSound(noteIdx, true);
        flashMsg('+' + pts + (gameCombo > 1 ? '  √ó' + gameCombo + ' combo!' : ''), '#55efc4');
        pulseScore();
    } else {
        gameLives--;
        updateLives();
        gameCombo = 0;
        playGameSound(noteIdx, false);
        flashMsg('In spec ‚Äî don\'t touch! ‚àí‚ô•', '#ff7675');
        shakeGame();
        if (gameLives <= 0) { gameOver('lives'); return; }
    }
    clearKey(key);
}

function clearKey(key) {
    clearTimeout(keyTimers.get(key));
    keyTimers.delete(key);
    delete key.dataset.active;
    delete key.dataset.type;
    key.classList.remove('gk-heavy', 'gk-light', 'gk-good');
    key.querySelectorAll('.gk-badge, .gk-bar').forEach(function(el) { el.remove(); });
}

function updateLives() {
    document.getElementById('g-lives').textContent = '‚ô•'.repeat(Math.max(0, gameLives)) + '‚ô°'.repeat(Math.max(0, 3 - gameLives));
}

function flashMsg(text, color) {
    const el = document.getElementById('g-msg');
    el.textContent = text; el.style.color = color;
    clearTimeout(el._t);
    el._t = setTimeout(function() { el.textContent = ''; }, 1400);
}

function pulseScore() {
    const el = document.getElementById('g-score');
    el.classList.remove('g-pulse'); void el.offsetWidth; el.classList.add('g-pulse');
    setTimeout(function() { el.classList.remove('g-pulse'); }, 300);
}

function shakeGame() {
    const el = document.getElementById('game-container');
    el.classList.remove('g-shake'); void el.offsetWidth; el.classList.add('g-shake');
    setTimeout(function() { el.classList.remove('g-shake'); }, 350);
}

function gameOver(reason) {
    gameActive = false;
    clearInterval(gameTimerInt); clearInterval(gameSpawnInt);
    document.querySelectorAll('.gk').forEach(clearKey);
    const isNew = gameScore > gameHighScore;
    if (isNew) gameHighScore = gameScore;
    const grades = [
        [150, 'üèÜ Master Technician!'],
        [90,  'ü•á Expert Regulator!'],
        [50,  'üéµ Competent Tuner'],
        [20,  'üîß Apprentice'],
        [0,   'üéπ Keep practicing!'],
    ];
    const grade = grades.find(function(g) { return gameScore >= g[0]; })[1];
    document.getElementById('g-reason').textContent = reason === 'lives' ? 'Out of lives!' : 'Time\'s up!';
    document.getElementById('g-final').textContent = gameScore;
    document.getElementById('g-best').textContent = gameHighScore;
    document.getElementById('g-grade').textContent = grade;
    document.getElementById('g-newbest').style.display = isNew ? '' : 'none';
    showGamePanel('game-over');
}

function stopGame() {
    gameActive = false;
    clearInterval(gameTimerInt); gameTimerInt = null;
    clearInterval(gameSpawnInt); gameSpawnInt = null;
    keyTimers.forEach(function(tid) { clearTimeout(tid); });
    keyTimers.clear();
}

function playGameSound(noteIdx, success) {
    try {
        if (!gameAudio) gameAudio = new (window.AudioContext || window.webkitAudioContext)();
        const ac = gameAudio;
        const osc = ac.createOscillator();
        const gain = ac.createGain();
        osc.connect(gain); gain.connect(ac.destination);
        if (success) {
            osc.type = 'triangle';
            osc.frequency.value = GAME_FREQS[noteIdx];
            gain.gain.setValueAtTime(0.16, ac.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, ac.currentTime + 0.55);
            osc.start(); osc.stop(ac.currentTime + 0.55);
        } else {
            osc.type = 'sawtooth';
            osc.frequency.value = 85;
            gain.gain.setValueAtTime(0.1, ac.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, ac.currentTime + 0.22);
            osc.start(); osc.stop(ac.currentTime + 0.22);
        }
    } catch(e) {}
}

// ‚îÄ‚îÄ Event Listeners ‚îÄ‚îÄ

// Drag and drop
const dropZone = document.getElementById('drop-zone');
dropZone.addEventListener('dragover', function(e) {
    e.preventDefault();
    dropZone.classList.add('dragover');
});
dropZone.addEventListener('dragleave', function() {
    dropZone.classList.remove('dragover');
});
dropZone.addEventListener('drop', function(e) {
    e.preventDefault();
    dropZone.classList.remove('dragover');
    const file = e.dataTransfer.files[0];
    if (file) readJSONFile(file);
});
dropZone.addEventListener('click', function() {
    document.getElementById('file-input').click();
});
document.getElementById('file-input').addEventListener('change', function(e) {
    if (e.target.files[0]) readJSONFile(e.target.files[0]);
});

// Keyboard navigation
document.addEventListener('keydown', function(e) {
    if (!kmdData) return;
    if (currentView === 'single') {
        if (e.key === 'ArrowLeft') { e.preventDefault(); navigateKey(-1); }
        if (e.key === 'ArrowRight') { e.preventDefault(); navigateKey(1); }
    }
    if (e.key === 'Escape') {
        switchView('single');
    }
});

// ‚îÄ‚îÄ Initialization ‚îÄ‚îÄ
(function init() {
    // Check for CDN availability
    if (typeof Chart === 'undefined') {
        document.getElementById('landing').innerHTML =
            '<h1>KMD Piano Data Viewer</h1>' +
            '<p class="subtitle" style="color:#b91c1c">Chart.js could not be loaded. Please check your internet connection and refresh the page.</p>';
        return;
    }

    // Check for embedded data
    const embeddedEl = document.getElementById('embedded-data');
    if (embeddedEl) {
        const content = embeddedEl.textContent.trim();
        if (content && content !== 'null') {
            try {
                const jsonStr = decodeURIComponent(escape(atob(content)));
                const data = JSON.parse(jsonStr);
                loadData(data);
                return;
            } catch (e) {
                // Embedded data invalid, fall through to landing page
            }
        }
    }

    // Show landing page
    document.getElementById('landing').style.display = '';
})();
</script>

</body>
</html>
